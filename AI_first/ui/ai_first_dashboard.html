<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI_first Control Panel</title>
  <link rel="stylesheet" href="style/bugmgmt.css" />
  <style>
    .status-row {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #9ca3af;
      box-shadow: 0 0 0 3px rgba(156, 163, 175, 0.2);
    }
    .status-dot.ok {
      background: #16a34a;
      box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.2);
    }
    .status-dot.error {
      background: #dc2626;
      box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.2);
    }
    .status-dot.loading {
      background: #f59e0b;
      box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.2);
    }
    .action-grid {
      display: grid;
      gap: 12px;
    }
    .action-item {
      padding: 12px;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      background: #fff;
    }
    .action-item .title {
      font-weight: 700;
      margin-bottom: 4px;
    }
    .action-item .desc {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 8px;
    }
    .action-item .cmd {
      font-size: 12px;
      color: #4b5563;
      margin-top: 8px;
    }
    .job-list {
      font-size: 12px;
    }
    .job {
      padding: 8px 0;
      border-bottom: 1px solid #e5e7eb;
    }
    .job:last-child {
      border-bottom: none;
    }
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: #111827;
      color: #fff;
      padding: 10px 14px;
      border-radius: 10px;
      font-size: 12px;
      opacity: 0;
      transform: translateY(6px);
      transition: opacity 0.2s ease, transform 0.2s ease;
      pointer-events: none;
    }
    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }
    .input-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      margin: 10px 0 6px;
    }
    .input-row input {
      width: 100%;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 8px 10px;
      font-size: 12px;
    }
    .input-row select {
      width: 100%;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 8px 10px;
      font-size: 12px;
      background: #fff;
    }
    .output-list {
      font-size: 12px;
      color: #4b5563;
    }
    .input-row textarea {
      width: 100%;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 8px 10px;
      font-size: 12px;
      min-height: 90px;
      resize: vertical;
    }
    .style-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 14px;
      margin-top: 12px;
    }
    .style-card {
      border: 1px solid #e5e7eb;
      border-radius: 14px;
      padding: 12px;
      background: #fff;
      display: grid;
      gap: 8px;
    }
    .style-card .title {
      font-weight: 700;
    }
    .style-card .meta {
      font-size: 12px;
      color: #6b7280;
    }
    .style-card .actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .style-card.active {
      border-color: #111827;
      box-shadow: 0 6px 14px rgba(17, 24, 39, 0.12);
    }
    .style-active {
      font-size: 12px;
      color: #4b5563;
      margin-top: 6px;
    }
    .entry-list {
      margin-top: 10px;
      font-size: 12px;
      color: #4b5563;
      display: grid;
      gap: 6px;
    }
    .issue-form {
      display: grid;
      gap: 10px;
      margin-bottom: 10px;
    }
    .issue-table select,
    .issue-table input {
      font-size: 12px;
      padding: 6px 8px;
    }
    .issue-table td {
      vertical-align: top;
      font-size: 12px;
    }
    .reintegration-results {
      font-size: 12px;
      color: #4b5563;
      display: grid;
      gap: 6px;
      margin-top: 8px;
    }
    .reintegration-files {
      font-size: 12px;
      color: #4b5563;
      max-height: 160px;
      overflow: auto;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 8px;
      background: #fff;
    }
  </style>
</head>
<body>
  <div class="container">
    <nav class="top-nav">
      <a class="nav-link nav-home" href="index.html">Home</a>
      <a class="nav-link nav-process" href="process_guide.html">Process Management</a>
      <a class="nav-link nav-project" href="PM.html">Project Management</a>
      <a class="nav-link nav-bug" href="bugmgmt_issues.html">Bug Management</a>
      <a class="nav-link nav-control" href="ai_first_dashboard.html">Control Panel</a>
    </nav>
    <header class="hero">
      <div>
        <h1 class="h4">AI_first Control Panel</h1>
        <p class="muted small">Run refresh actions from the browser and confirm the control server connection health.</p>
      </div>
    </header>

    <section class="card">
      <h2 class="h4">Connection</h2>
      <div class="input-row">
        <div>
          <label class="muted small">API base</label>
          <input id="api-base" placeholder="http://127.0.0.1:8790" />
        </div>
      </div>
      <div class="status-row">
        <button class="btn" id="check-connection">Check connection</button>
        <span class="status-dot" id="conn-dot"></span>
        <span class="muted small" id="conn-label">Idle</span>
        <span class="muted small" id="conn-detail">No checks yet.</span>
      </div>
    </section>

    <section class="card">
      <h2 class="h4">UI Style Gallery</h2>
      <p class="muted small">Pick a template, preview it, and copy a Codex hint when you start a new UI build.</p>
      <div class="style-active" id="style-active">Active style: none selected.</div>
      <div class="input-row">
        <div>
          <label class="muted small">Style notes for Codex</label>
          <textarea id="style-notes" placeholder="Add extra guidance for the active template..."></textarea>
        </div>
      </div>
      <div class="status-row">
        <button class="btn" id="save-style-notes">Save notes</button>
        <button class="btn" id="copy-active-style">Copy active style hint</button>
      </div>
      <div class="style-grid" id="style-grid"></div>
    </section>

    <section class="card">
      <h2 class="h4">Simple Project Log</h2>
      <p class="muted small">High-level, agile project context for quick handoff and continuity.</p>
      <div class="input-row">
        <div>
          <label class="muted small">Project title</label>
          <input id="project-title" placeholder="Project title" />
        </div>
      </div>
      <div class="input-row">
        <div>
          <label class="muted small">Current summary</label>
          <textarea id="project-summary" placeholder="What is the current focus and what decisions matter?"></textarea>
        </div>
      </div>
      <div class="status-row">
        <button class="btn" id="save-project">Save project log</button>
        <span class="muted small" id="project-status">Not saved yet.</span>
      </div>
      <div class="input-row">
        <div>
          <label class="muted small">Add update</label>
          <input id="project-entry" placeholder="Short update to append to the log" />
        </div>
        <div>
          <label class="muted small">&nbsp;</label>
          <button class="btn" id="add-project-entry">Add update</button>
        </div>
      </div>
      <div class="entry-list" id="project-entries">No updates yet.</div>
    </section>

    <section class="card">
      <h2 class="h4">Quick Issues</h2>
      <p class="muted small">Lightweight issue list to capture and revisit open items without losing them.</p>
      <div class="issue-form">
        <div class="input-row">
          <div>
            <label class="muted small">Title</label>
            <input id="issue-title" placeholder="Issue summary" />
          </div>
          <div>
            <label class="muted small">Owner</label>
            <input id="issue-owner" placeholder="Owner (optional)" />
          </div>
        </div>
        <div class="input-row">
          <div>
            <label class="muted small">Priority</label>
            <select id="issue-priority">
              <option value="high">High</option>
              <option value="medium" selected>Medium</option>
              <option value="low">Low</option>
            </select>
          </div>
          <div>
            <label class="muted small">Status</label>
            <select id="issue-status">
              <option value="open" selected>Open</option>
              <option value="in_progress">In progress</option>
              <option value="closed">Closed</option>
            </select>
          </div>
          <div>
            <label class="muted small">Tags (comma separated)</label>
            <input id="issue-tags" placeholder="ui, docs" />
          </div>
        </div>
        <div class="input-row">
          <div>
            <label class="muted small">Notes</label>
            <textarea id="issue-notes" placeholder="Context, reproduction, or notes"></textarea>
          </div>
        </div>
        <div class="status-row">
          <button class="btn" id="add-issue">Add issue</button>
          <span class="muted small" id="issue-status-label">No issues yet.</span>
        </div>
      </div>
      <div class="table-wrap issue-table">
        <table class="issues">
          <thead>
            <tr>
              <th>ID</th>
              <th>Title</th>
              <th>Status</th>
              <th>Priority</th>
              <th>Owner</th>
              <th>Tags</th>
              <th>Updated</th>
              <th>Notes</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="issues-body"></tbody>
        </table>
      </div>
    </section>

    <section class="card">
      <h2 class="h4">Reintegration</h2>
      <p class="muted small">Copy an external AI_first into scratch and review differences before reintegrating.</p>
      <div class="input-row">
        <div>
          <label class="muted small">Source path (repo or AI_first directory)</label>
          <input id="reintegration-source" placeholder="/path/to/other/repo" />
        </div>
      </div>
      <div class="status-row">
        <button class="btn" id="run-reintegration">Run reintegration scan</button>
        <span class="muted small" id="reintegration-status">No scans yet.</span>
      </div>
      <div class="reintegration-results" id="reintegration-results">Awaiting scan.</div>
      <div class="reintegration-files" id="reintegration-files">No changed files yet.</div>
    </section>

    <section class="card">
      <h2 class="h4">Quick Actions</h2>
      <div class="action-grid" id="action-grid"></div>
    </section>

    <section class="card">
      <h2 class="h4">Outputs</h2>
      <div class="output-list" id="output-list">No status yet.</div>
    </section>

    <section class="card">
      <h2 class="h4">Recent Jobs</h2>
      <div class="job-list" id="job-list">No jobs yet.</div>
    </section>
  </div>

  <div class="toast" id="toast">Copied</div>

  <script>
    const apiInput = document.getElementById("api-base");
    const checkBtn = document.getElementById("check-connection");
    const connDot = document.getElementById("conn-dot");
    const connLabel = document.getElementById("conn-label");
    const connDetail = document.getElementById("conn-detail");
    const actionGrid = document.getElementById("action-grid");
    const jobList = document.getElementById("job-list");
    const outputList = document.getElementById("output-list");
    const toast = document.getElementById("toast");
    const styleGrid = document.getElementById("style-grid");
    const styleActive = document.getElementById("style-active");
    const styleNotes = document.getElementById("style-notes");
    const saveStyleNotesBtn = document.getElementById("save-style-notes");
    const copyActiveStyleBtn = document.getElementById("copy-active-style");
    const projectTitle = document.getElementById("project-title");
    const projectSummary = document.getElementById("project-summary");
    const projectStatus = document.getElementById("project-status");
    const saveProjectBtn = document.getElementById("save-project");
    const projectEntry = document.getElementById("project-entry");
    const addProjectEntryBtn = document.getElementById("add-project-entry");
    const projectEntries = document.getElementById("project-entries");
    const issueTitle = document.getElementById("issue-title");
    const issueOwner = document.getElementById("issue-owner");
    const issuePriority = document.getElementById("issue-priority");
    const issueStatus = document.getElementById("issue-status");
    const issueTags = document.getElementById("issue-tags");
    const issueNotes = document.getElementById("issue-notes");
    const addIssueBtn = document.getElementById("add-issue");
    const issueStatusLabel = document.getElementById("issue-status-label");
    const issuesBody = document.getElementById("issues-body");
    const reintegrationSource = document.getElementById("reintegration-source");
    const runReintegrationBtn = document.getElementById("run-reintegration");
    const reintegrationStatus = document.getElementById("reintegration-status");
    const reintegrationResults = document.getElementById("reintegration-results");
    const reintegrationFiles = document.getElementById("reintegration-files");

    let apiBase = "";
    let apiOnline = false;
    let jobs = [];
    let styleSelection = { active_template_id: "", notes: "" };
    let simpleProject = null;
    let quickIssues = [];

    const styleTemplates = [
      {
        id: "atlas_ledger",
        name: "Atlas Ledger",
        file: "templates/ui_style_atlas.html",
        summary: "Editorial serif hierarchy with paper texture and calm accents.",
        hint: "Use the Atlas Ledger UI style: serif headlines (Georgia), muted paper background, warm accent #c05621, card-based layout, and generous whitespace. Reference AI_first/ui/templates/ui_style_atlas.html."
      },
      {
        id: "signal_mono",
        name: "Signal Mono",
        file: "templates/ui_style_signal.html",
        summary: "Technical control surface with mono headers and teal accents.",
        hint: "Use the Signal Mono UI style: monospace headers, console-like panels, teal accent #0f766e, crisp borders, and light blueprint background. Reference AI_first/ui/templates/ui_style_signal.html."
      },
      {
        id: "studio_blocks",
        name: "Studio Blocks",
        file: "templates/ui_style_studio.html",
        summary: "Bold, colorful blocks for friendly, energetic dashboards.",
        hint: "Use the Studio Blocks UI style: bold color panels, warm gradients, friendly sans serif (Gill Sans/Trebuchet), and playful pills. Reference AI_first/ui/templates/ui_style_studio.html."
      },
      {
        id: "stage_cards",
        name: "Stage Cards",
        file: "templates/ui_style_stage_cards.html",
        summary: "Stage roadmap card grid with status borders and badges.",
        hint: "Use the Stage Cards UI style: stage roadmap grid, status-colored borders (green/amber/blue/red), hero panel + alert banner, and small status chips. Reference AI_first/ui/templates/ui_style_stage_cards.html."
      },
      {
        id: "kpi_dashboard",
        name: "KPI Dashboard",
        file: "templates/ui_style_kpi_dashboard.html",
        summary: "Operational KPI overview with donut chart + summary cards.",
        hint: "Use the KPI Dashboard UI style: KPI cards, donut completion chart, focus list, and soft gradient background with Verdana/mono accents. Reference AI_first/ui/templates/ui_style_kpi_dashboard.html."
      },
      {
        id: "report_table",
        name: "Report Table",
        file: "templates/ui_style_report_table.html",
        summary: "Dense report table with summary cards and legend tags.",
        hint: "Use the Report Table UI style: summary KPI cards, legend tags, fixed table header styling, and light neutral background. Reference AI_first/ui/templates/ui_style_report_table.html."
      }
    ];

    const actions = [
      {
        id: "refresh_all",
        title: "Refresh all",
        desc: "Render docs + PM report + BugMgmt exports.",
        fallback: "python3 AI_first/scripts/render_docs.py && python3 AI_first/scripts/render_pm.py && python3 AI_first/scripts/issues.py list --format json --output AI_first/bugmgmt/exports/json/bugmgmt_issues.json && python3 AI_first/scripts/issues.py list --format html --output AI_first/ui/bugmgmt_issues.html"
      },
      {
        id: "render_docs",
        title: "Render docs",
        desc: "Refresh AI_first/ui/docs from markdown.",
        fallback: "python3 AI_first/scripts/render_docs.py"
      },
      {
        id: "render_pm",
        title: "Render PM report",
        desc: "Refresh AI_first/ui/PM.html and project detail pages.",
        fallback: "python3 AI_first/scripts/render_pm.py"
      },
      {
        id: "bugmgmt_export",
        title: "Export BugMgmt",
        desc: "Regenerate BugMgmt JSON + HTML exports.",
        fallback: "python3 AI_first/scripts/issues.py list --format json --output AI_first/bugmgmt/exports/json/bugmgmt_issues.json && python3 AI_first/scripts/issues.py list --format html --output AI_first/ui/bugmgmt_issues.html"
      }
    ];

    function showToast(message) {
      toast.textContent = message;
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 1500);
    }

    async function copyText(text) {
      try {
        if (navigator.clipboard && window.isSecureContext) {
          await navigator.clipboard.writeText(text);
        } else {
          const area = document.createElement("textarea");
          area.value = text;
          document.body.appendChild(area);
          area.select();
          document.execCommand("copy");
          area.remove();
        }
        showToast("Copied");
      } catch (e) {
        showToast("Copy failed");
      }
    }

    function escapeHtml(value) {
      return String(value || "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function setStatus(state, message) {
      connDot.classList.remove("ok", "error", "loading");
      if (state) connDot.classList.add(state);
      connLabel.textContent = message;
    }

    function loadConfig() {
      apiBase = localStorage.getItem("ai-first-api-base") || "http://127.0.0.1:8790";
      apiInput.value = apiBase;
    }

    function saveConfig() {
      apiBase = apiInput.value.trim() || "http://127.0.0.1:8790";
      apiBase = apiBase.replace(/\/+$/, "");
      localStorage.setItem("ai-first-api-base", apiBase);
    }

    async function fetchStatus() {
      saveConfig();
      setStatus("loading", "Checking...");
      connDetail.textContent = "Connecting...";
      try {
        const resp = await fetch(`${apiBase}/api/status`);
        if (!resp.ok) throw new Error(`status ${resp.status}`);
        const payload = await resp.json();
        apiOnline = true;
        setStatus("ok", "Connected");
        connDetail.textContent = `Server time: ${payload.server_time}`;
        jobs = payload.jobs || [];
        renderJobs();
        renderOutputs(payload.outputs || {});
        await fetchStyleSelection();
        await fetchSimpleProject();
        await fetchQuickIssues();
        await fetchReintegration();
      } catch (e) {
        apiOnline = false;
        setStatus("error", "Offline");
        connDetail.textContent = "Unable to reach control server.";
      }
    }

    function renderJobs() {
      if (!jobs.length) {
        jobList.textContent = "No jobs yet.";
        return;
      }
      jobList.innerHTML = jobs.map(job => {
        const time = job.ended_at || job.started_at || "";
        return `<div class="job">
          <div><strong>${job.action}</strong> · ${job.status}</div>
          <div class="muted small">Started: ${job.started_at || "-"} · Ended: ${job.ended_at || "-"}</div>
          <div class="muted small">Log: ${job.log_url || "-"}</div>
        </div>`;
      }).join("");
    }

    function renderOutputs(outputs) {
      const entries = [
        ["PM report", outputs.pm_html],
        ["BugMgmt UI", outputs.bugmgmt_html],
        ["Docs (process)", outputs.docs_process]
      ];
      outputList.innerHTML = entries.map(([label, value]) => {
        return `<div>${label}: <span class="mono">${value || "unknown"}</span></div>`;
      }).join("");
    }

    async function apiGet(path) {
      const resp = await fetch(`${apiBase}${path}`);
      if (!resp.ok) throw new Error(`GET ${path} ${resp.status}`);
      return await resp.json();
    }

    async function apiPost(path, payload) {
      const resp = await fetch(`${apiBase}${path}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload || {})
      });
      if (!resp.ok) throw new Error(`POST ${path} ${resp.status}`);
      return await resp.json();
    }

    function renderStyleCards() {
      const activeId = styleSelection.active_template_id;
      const activeTemplate = styleTemplates.find(t => t.id === activeId);
      styleActive.textContent = activeTemplate
        ? `Active style: ${activeTemplate.name}`
        : "Active style: none selected.";
      styleNotes.value = styleSelection.notes || "";
      styleGrid.innerHTML = styleTemplates.map(template => {
        const isActive = template.id === activeId;
        return `<div class="style-card ${isActive ? "active" : ""}">
          <div class="title">${template.name}</div>
          <div class="meta">${template.summary}</div>
          <div class="meta">File: <span class="mono">AI_first/ui/${template.file}</span></div>
          <div class="actions">
            <a class="btn" href="${template.file}" target="_blank" rel="noopener">Preview</a>
            <button class="btn" data-style="${template.id}" data-action="copy">Copy hint</button>
            <button class="btn" data-style="${template.id}" data-action="activate">Set active</button>
          </div>
        </div>`;
      }).join("");
      styleGrid.querySelectorAll("button[data-style]").forEach(btn => {
        btn.addEventListener("click", async () => {
          const styleId = btn.getAttribute("data-style");
          const action = btn.getAttribute("data-action");
          const template = styleTemplates.find(t => t.id === styleId);
          if (!template) return;
          if (action === "copy") {
            await copyText(buildStyleHint(template));
            return;
          }
          if (action === "activate") {
            await setActiveStyle(template.id);
          }
        });
      });
    }

    function buildStyleHint(template) {
      const notes = (styleSelection.notes || "").trim();
      if (!notes) return template.hint;
      return `${template.hint}\nExtra notes: ${notes}`;
    }

    async function setActiveStyle(styleId) {
      if (!apiOnline) {
        await fetchStatus();
      }
      if (!apiOnline) {
        showToast("Control server offline.");
        return;
      }
      try {
        styleSelection = await apiPost("/api/ui-style", { active_template_id: styleId, notes: styleNotes.value });
        renderStyleCards();
        showToast("Active style updated.");
      } catch (e) {
        showToast("Failed to update style.");
      }
    }

    async function saveStyleNotes() {
      if (!apiOnline) {
        await fetchStatus();
      }
      if (!apiOnline) {
        showToast("Control server offline.");
        return;
      }
      try {
        styleSelection = await apiPost("/api/ui-style", { notes: styleNotes.value, active_template_id: styleSelection.active_template_id });
        renderStyleCards();
        showToast("Notes saved.");
      } catch (e) {
        showToast("Failed to save notes.");
      }
    }

    async function fetchStyleSelection() {
      if (!apiOnline) return;
      try {
        styleSelection = await apiGet("/api/ui-style");
        renderStyleCards();
      } catch (e) {
        renderStyleCards();
      }
    }

    function renderSimpleProject() {
      if (!simpleProject) return;
      projectTitle.value = simpleProject.title || "";
      projectSummary.value = simpleProject.summary || "";
      const entries = simpleProject.entries || [];
      if (!entries.length) {
        projectEntries.textContent = "No updates yet.";
      } else {
        projectEntries.innerHTML = entries.map(entry => {
          return `<div>- ${escapeHtml(entry.date)} — ${escapeHtml(entry.text)}</div>`;
        }).join("");
      }
      projectStatus.textContent = `Last saved: ${simpleProject.updated_at || "unknown"}`;
    }

    async function fetchSimpleProject() {
      if (!apiOnline) return;
      try {
        simpleProject = await apiGet("/api/simple-project");
        renderSimpleProject();
      } catch (e) {
        showToast("Failed to load project log.");
      }
    }

    async function saveProjectLog() {
      if (!apiOnline) {
        await fetchStatus();
      }
      if (!apiOnline) {
        showToast("Control server offline.");
        return;
      }
      try {
        simpleProject = await apiPost("/api/simple-project", {
          title: projectTitle.value,
          summary: projectSummary.value
        });
        renderSimpleProject();
        showToast("Project log saved.");
      } catch (e) {
        showToast("Failed to save project log.");
      }
    }

    async function addProjectEntry() {
      const text = projectEntry.value.trim();
      if (!text) {
        showToast("Add a short update first.");
        return;
      }
      if (!apiOnline) {
        await fetchStatus();
      }
      if (!apiOnline) {
        showToast("Control server offline.");
        return;
      }
      try {
        simpleProject = await apiPost("/api/simple-project", { entry: text });
        projectEntry.value = "";
        renderSimpleProject();
        showToast("Update added.");
      } catch (e) {
        showToast("Failed to add update.");
      }
    }

    function renderIssues() {
      if (!quickIssues.length) {
        issuesBody.innerHTML = "";
        issueStatusLabel.textContent = "No issues yet.";
        return;
      }
      issueStatusLabel.textContent = `${quickIssues.length} issue(s)`;
      issuesBody.innerHTML = quickIssues.map(issue => {
        const tags = escapeHtml((issue.tags || []).join(", "));
        const title = escapeHtml(issue.title || "");
        const owner = escapeHtml(issue.owner || "");
        const notes = escapeHtml(issue.notes || "");
        return `<tr>
          <td class="mono">${escapeHtml(issue.id || "")}</td>
          <td>${title}</td>
          <td>
            <select data-field="status" data-id="${issue.id}">
              <option value="open"${issue.status === "open" ? " selected" : ""}>Open</option>
              <option value="in_progress"${issue.status === "in_progress" ? " selected" : ""}>In progress</option>
              <option value="closed"${issue.status === "closed" ? " selected" : ""}>Closed</option>
            </select>
          </td>
          <td>
            <select data-field="priority" data-id="${issue.id}">
              <option value="high"${issue.priority === "high" ? " selected" : ""}>High</option>
              <option value="medium"${issue.priority === "medium" ? " selected" : ""}>Medium</option>
              <option value="low"${issue.priority === "low" ? " selected" : ""}>Low</option>
            </select>
          </td>
          <td><input data-field="owner" data-id="${issue.id}" value="${owner}" /></td>
          <td><input data-field="tags" data-id="${issue.id}" value="${tags}" /></td>
          <td>${issue.updated_at || issue.created_at || "-"}</td>
          <td><input data-field="notes" data-id="${issue.id}" value="${notes}" /></td>
          <td><button class="btn" data-save="${issue.id}">Save</button></td>
        </tr>`;
      }).join("");
      issuesBody.querySelectorAll("button[data-save]").forEach(btn => {
        btn.addEventListener("click", () => {
          const issueId = btn.getAttribute("data-save");
          const fields = {};
          issuesBody.querySelectorAll(`[data-id="${issueId}"]`).forEach(input => {
            const field = input.getAttribute("data-field");
            if (!field) return;
            fields[field] = input.value;
          });
          updateIssue(issueId, fields);
        });
      });
    }

    function renderReintegration(summary) {
      if (!summary || !summary.counts) {
        reintegrationResults.textContent = "Awaiting scan.";
        reintegrationFiles.textContent = "No changed files yet.";
        return;
      }
      const counts = summary.counts || {};
      reintegrationResults.innerHTML = `
        <div>Source: <span class="mono">${escapeHtml(summary.source_ai_first || "")}</span></div>
        <div>Scratch: <span class="mono">${escapeHtml(summary.scratch_copy || "")}</span></div>
        <div>Added: ${counts.added || 0} · Removed: ${counts.removed || 0} · Changed: ${counts.changed || 0}</div>
        <div>Copy mode: ${escapeHtml(summary.copy_mode || "unknown")}</div>
        <div>Last run: ${escapeHtml(summary.timestamp || "")}</div>
      `;
      const warnings = summary.warnings || [];
      if (warnings.length) {
        reintegrationResults.innerHTML += `<div class="muted small">Warning: ${escapeHtml(warnings.join(" "))}</div>`;
      }
      const changed = summary.changed || [];
      if (!changed.length) {
        reintegrationFiles.textContent = "No changed files.";
        return;
      }
      reintegrationFiles.innerHTML = changed.slice(0, 40).map(path => `- ${escapeHtml(path)}`).join("<br />");
      if (changed.length > 40) {
        reintegrationFiles.innerHTML += `<br />... ${changed.length - 40} more`;
      }
    }

    async function fetchReintegration() {
      if (!apiOnline) return;
      try {
        const summary = await apiGet("/api/reintegration");
        renderReintegration(summary);
      } catch (e) {
        renderReintegration(null);
      }
    }

    async function runReintegration() {
      const sourcePath = reintegrationSource.value.trim();
      if (!sourcePath) {
        showToast("Enter a source path.");
        return;
      }
      if (!apiOnline) {
        await fetchStatus();
      }
      if (!apiOnline) {
        showToast("Control server offline.");
        return;
      }
      try {
        reintegrationStatus.textContent = "Running scan...";
        const summary = await apiPost("/api/reintegration", { source_path: sourcePath });
        reintegrationStatus.textContent = "Scan complete.";
        renderReintegration(summary);
        showToast("Reintegration scan complete.");
      } catch (e) {
        reintegrationStatus.textContent = "Scan failed.";
        showToast("Reintegration failed.");
      }
    }

    async function fetchQuickIssues() {
      if (!apiOnline) return;
      try {
        const payload = await apiGet("/api/quick-issues");
        quickIssues = payload.issues || [];
        renderIssues();
      } catch (e) {
        showToast("Failed to load issues.");
      }
    }

    async function addIssue() {
      const title = issueTitle.value.trim();
      if (!title) {
        showToast("Issue title required.");
        return;
      }
      if (!apiOnline) {
        await fetchStatus();
      }
      if (!apiOnline) {
        showToast("Control server offline.");
        return;
      }
      try {
        const payload = await apiPost("/api/quick-issues", {
          action: "create",
          title,
          owner: issueOwner.value,
          priority: issuePriority.value,
          status: issueStatus.value,
          tags: issueTags.value,
          notes: issueNotes.value
        });
        quickIssues = payload.issues || [];
        issueTitle.value = "";
        issueOwner.value = "";
        issueTags.value = "";
        issueNotes.value = "";
        issuePriority.value = "medium";
        issueStatus.value = "open";
        renderIssues();
        showToast("Issue added.");
      } catch (e) {
        showToast("Failed to add issue.");
      }
    }

    async function updateIssue(issueId, fields) {
      if (!apiOnline) {
        await fetchStatus();
      }
      if (!apiOnline) {
        showToast("Control server offline.");
        return;
      }
      try {
        const payload = await apiPost("/api/quick-issues", {
          action: "update",
          id: issueId,
          ...fields
        });
        quickIssues = payload.issues || [];
        renderIssues();
        showToast("Issue updated.");
      } catch (e) {
        showToast("Failed to update issue.");
      }
    }

    async function runAction(action, fallbackCmd) {
      if (!apiOnline) {
        await fetchStatus();
      }
      if (!apiOnline) {
        await copyText(fallbackCmd);
        return;
      }
      try {
        const resp = await fetch(`${apiBase}/api/run`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ action })
        });
        if (!resp.ok) throw new Error(`run ${resp.status}`);
        const job = await resp.json();
        jobs = [job, ...jobs].slice(0, 8);
        renderJobs();
        showToast(`Started ${action}`);
        pollJob(job.id);
      } catch (e) {
        showToast("Failed to start action.");
      }
    }

    async function pollJob(jobId) {
      let done = false;
      while (!done) {
        try {
          const resp = await fetch(`${apiBase}/api/jobs/${jobId}?tail=8`);
          if (!resp.ok) throw new Error(`job ${resp.status}`);
          const payload = await resp.json();
          jobs = [payload, ...jobs.filter(j => j.id !== jobId)].slice(0, 8);
          renderJobs();
          if (payload.status === "done" || payload.status === "error") {
            done = true;
            await fetchStatus();
            return;
          }
        } catch (e) {
          done = true;
        }
        await new Promise(r => setTimeout(r, 1200));
      }
    }

    function renderActions() {
      actionGrid.innerHTML = actions.map(action => {
        return `<div class="action-item">
          <div class="title">${action.title}</div>
          <div class="desc">${action.desc}</div>
          <button class="btn" data-action="${action.id}">Run</button>
          <div class="cmd">Fallback: <span class="mono">${action.fallback}</span></div>
        </div>`;
      }).join("");
      actionGrid.querySelectorAll("button[data-action]").forEach(btn => {
        btn.addEventListener("click", () => {
          const action = btn.getAttribute("data-action");
          const spec = actions.find(item => item.id === action);
          if (!spec) return;
          runAction(spec.id, spec.fallback);
        });
      });
    }

    apiInput.addEventListener("change", saveConfig);
    checkBtn.addEventListener("click", fetchStatus);
    runReintegrationBtn.addEventListener("click", runReintegration);
    saveStyleNotesBtn.addEventListener("click", saveStyleNotes);
    copyActiveStyleBtn.addEventListener("click", async () => {
      const activeTemplate = styleTemplates.find(t => t.id === styleSelection.active_template_id);
      if (!activeTemplate) {
        showToast("Select a style first.");
        return;
      }
      await copyText(buildStyleHint(activeTemplate));
    });
    saveProjectBtn.addEventListener("click", saveProjectLog);
    addProjectEntryBtn.addEventListener("click", addProjectEntry);
    addIssueBtn.addEventListener("click", addIssue);

    loadConfig();
    renderStyleCards();
    renderActions();
    fetchStatus();
  </script>
</body>
</html>
